<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planning Builder FR</title>
<style>
  :root {
    --primary: #2563eb;
    --primary-light: #dbeafe;
    --night: #1e1b4b;
    --day: #fef3c7;
    --danger: #dc2626;
    --warn: #d97706;
    --success: #16a34a;
    --sunday: #fce7f3;
    --holiday: #fef2f2;
    --border: #e5e7eb;
    --bg: #f9fafb;
    --card: #fff;
    --text: #111827;
    --muted: #6b7280;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }
  h1 { font-size: 1.4rem; font-weight: 700; }
  h2 { font-size: 1rem; font-weight: 600; margin-bottom: 10px; }
  h3 { font-size: .9rem; font-weight: 600; margin-bottom: 6px; }
  .app { max-width: 1100px; margin: 0 auto; padding: 16px; }
  header { background: var(--primary); color: #fff; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
  header span { font-size: .85rem; opacity: .8; }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
  label { display: block; font-size: .8rem; color: var(--muted); margin-bottom: 3px; }
  input[type=date], input[type=time], select { border: 1px solid var(--border); border-radius: 5px; padding: 5px 8px; font-size: .9rem; width: 100%; }
  input[type=checkbox] { width: 16px; height: 16px; cursor: pointer; }
  .day-row { display: grid; grid-template-columns: 70px 32px 1fr 1fr auto; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border); }
  .day-row:last-child { border-bottom: none; }
  .day-label { font-weight: 500; font-size: .85rem; }
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
  .kpi { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; }
  .kpi .val { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
  .kpi .lbl { font-size: .75rem; color: var(--muted); margin-top: 2px; }
  .timeline { position: relative; height: 28px; background: #f3f4f6; border-radius: 4px; overflow: hidden; margin: 4px 0; }
  .tl-bar { position: absolute; height: 100%; opacity: .85; }
  .tl-day { background: #fbbf24; }
  .tl-night { background: #6366f1; }
  .badge { display: inline-block; font-size: .7rem; padding: 1px 6px; border-radius: 10px; font-weight: 600; margin-left: 4px; }
  .badge-sun { background: #fce7f3; color: #be185d; }
  .badge-hol { background: #fee2e2; color: #dc2626; }
  .alert { border-radius: 6px; padding: 10px 14px; margin-bottom: 12px; font-size: .85rem; }
  .alert-err { background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
  .alert-ok { background: #d1fae5; border: 1px solid #6ee7b7; color: #065f46; }
  .alert-warn { background: #fef3c7; border: 1px solid #fde68a; color: #92400e; }
  button { cursor: pointer; border: none; border-radius: 6px; padding: 7px 14px; font-size: .85rem; font-weight: 500; transition: opacity .15s; }
  button:hover { opacity: .85; }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-sec { background: #e5e7eb; color: var(--text); }
  .btn-sm { padding: 4px 10px; font-size: .78rem; }
  .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
  .tab { padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: .85rem; background: #e5e7eb; }
  .tab.active { background: var(--primary); color: #fff; }
  .period-list { max-height: 400px; overflow-y: auto; }
  .period-row { display: grid; grid-template-columns: 90px 60px 1fr auto; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: .82rem; }
  .period-row:last-child { border-bottom: none; }
  .help-box { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 14px; font-size: .82rem; line-height: 1.6; }
  .help-box h3 { color: var(--primary); }
  details summary { cursor: pointer; font-weight: 600; color: var(--primary); margin-bottom: 8px; }
  .stat-bar { height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 4px; overflow: hidden; }
  .stat-fill { height: 100%; border-radius: 4px; background: var(--primary); }
  .tl-labels { display: flex; justify-content: space-between; font-size: .65rem; color: var(--muted); }
  .flex { display: flex; gap: 8px; align-items: center; }
  .mt { margin-top: 12px; }
  .mb { margin-bottom: 12px; }
  .col { display: flex; flex-direction: column; gap: 12px; }
  @media(max-width:700px) { .grid2 { grid-template-columns: 1fr; } .grid3 { grid-template-columns: 1fr 1fr; } }
</style>
</head>
<body>
<div class="app">
<header>
  <div>
    <h1>üìÖ Planning Builder FR</h1>
    <span>Planification horaire ¬∑ Calcul jour/nuit/dimanche/f√©ri√© ¬∑ Conformit√© l√©gale</span>
  </div>
  <div style="margin-left:auto; display:flex; gap:8px;">
    <button class="btn-sec btn-sm" onclick="exportCSV()">‚¨á CSV</button>
    <button class="btn-sec btn-sm" onclick="copyResume()">üìã R√©sum√©</button>
  </div>
</header>

<div id="alerts"></div>

<div class="grid2 mb">
  <!-- P√âRIODE -->
  <div class="card">
    <h2>üìÜ P√©riode</h2>
    <div class="grid2">
      <div>
        <label>Date d√©but</label>
        <input type="date" id="dateStart" onchange="compute()">
      </div>
      <div>
        <label>Date fin</label>
        <input type="date" id="dateEnd" onchange="compute()">
      </div>
    </div>
    <div id="periodInfo" style="margin-top:10px; font-size:.82rem; color:var(--muted);"></div>
  </div>

  <!-- PARAM√àTRES -->
  <div class="card">
    <h2>üá´üá∑ Param√®tres France</h2>
    <label>R√©gion</label>
    <select><option>France m√©tropole</option></select>
    <div id="holidays-preview" style="margin-top:10px; font-size:.78rem; color:var(--muted); max-height:80px; overflow-y:auto;"></div>
  </div>
</div>

<!-- POSTE -->
<div class="card mb">
  <h2>üïê D√©finition du poste (semaine type)</h2>
  <div style="font-size:.78rem; color:var(--muted); margin-bottom:10px;">Pour chaque jour, activez et saisissez les horaires. Les cr√©neaux passant minuit sont support√©s (ex: 21:00 ‚Üí 05:00).</div>
  <div id="week-table"></div>
  <div class="mt flex">
    <button class="btn-primary btn-sm" onclick="compute()">üîÑ Recalculer</button>
    <button class="btn-sec btn-sm" onclick="resetWeek()">R√©initialiser</button>
  </div>
</div>

<!-- KPI -->
<div class="card mb">
  <h2>üìä R√©sultats</h2>
  <div id="kpi-grid" class="kpi-grid"></div>
  <div id="benchmarks" style="margin-top:12px; font-size:.82rem;"></div>
</div>

<!-- PLANNING VISUEL -->
<div class="card mb">
  <h2>üëÅ Planning visuel</h2>
  <div class="tabs">
    <div class="tab active" onclick="showTab('week', this)">Semaine type</div>
    <div class="tab" onclick="showTab('period', this)">P√©riode</div>
    <div class="tab" onclick="showTab('help', this)">‚ùì Aide</div>
  </div>
  <div id="tab-week"></div>
  <div id="tab-period" style="display:none"></div>
  <div id="tab-help" style="display:none">
    <div class="help-box">
      <details open>
        <summary>Comment d√©finir un poste</summary>
        <p>Choisissez une p√©riode (date d√©but ‚Üí fin), puis pour chaque jour de la semaine, activez le toggle et saisissez heure d√©but / heure fin. Un cr√©neau passant minuit (ex: 21:00 ‚Üí 05:00) est automatiquement scind√© sur deux dates dans les calculs.</p>
      </details>
      <details style="margin-top:10px">
        <summary>Calcul jour / nuit / dimanche / f√©ri√©</summary>
        <p><b>Jour :</b> 06:00 ‚Üí 21:00 (exclus). <b>Nuit :</b> 21:00 ‚Üí 06:00 (couvre 21h‚Äìminuit et 0h‚Äì6h).<br>
        <b>Dimanche</b> : tout segment tombant un dimanche est compt√© s√©par√©ment (jour ou nuit).<br>
        <b>F√©ri√©</b> : si un jour est f√©ri√©, ses heures sont compt√©es en "F√©ri√©" (jour ou nuit). <b>Pas de double-compte</b> : une minute compte dans une seule cat√©gorie (priorit√© : F√©ri√© > Dimanche > Jour/Nuit normal).</p>
      </details>
      <details style="margin-top:10px">
        <summary>R√®gles 12h / 12h repos / 48h</summary>
        <p><b>Max 12h/jour :</b> aucun shift ne peut d√©passer 12h sur une m√™me date.<br>
        <b>Repos 12h :</b> entre la fin d'un shift et le d√©but du suivant, au moins 12h d'√©cart.<br>
        <b>Max 48h/semaine ISO :</b> la somme des heures sur une semaine (Lun‚ÜíDim) ne peut d√©passer 48h.<br>
        L'outil signale ces violations par des alertes en rouge et refuse l'export CSV si des erreurs critiques sont d√©tect√©es.</p>
      </details>
      <details style="margin-top:10px">
        <summary>Jours f√©ri√©s France (m√©tropole)</summary>
        <p>Calcul√©s automatiquement pour toute ann√©e : 1 Jan, Lundi de P√¢ques, 1 Mai, 8 Mai, Ascension, Lundi de Pentec√¥te, 14 Juil, 15 Ao√ªt, 1 Nov, 11 Nov, 25 D√©c.</p>
      </details>
    </div>
  </div>
</div>

</div>

<script>
// ===================== JOURS F√âRI√âS =====================
function easterSunday(y) {
  const a = y % 19, b = Math.floor(y/100), c = y % 100;
  const d = Math.floor(b/4), e = b % 4, f = Math.floor((b+8)/25);
  const g = Math.floor((b-f+1)/3), h = (19*a+b-d-g+15) % 30;
  const i = Math.floor(c/4), k = c % 4;
  const l = (32+2*e+2*i-h-k) % 7;
  const m = Math.floor((a+11*h+22*l)/451);
  const month = Math.floor((h+l-7*m+114)/31);
  const day = ((h+l-7*m+114) % 31) + 1;
  return new Date(y, month-1, day);
}

function getHolidays(y) {
  const e = easterSunday(y);
  const add = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
  const fmt = d => d.toISOString().slice(0,10);
  const list = [
    [fmt(new Date(y,0,1)), "Jour de l'An"],
    [fmt(add(e,1)), "Lundi de P√¢ques"],
    [fmt(new Date(y,4,1)), "F√™te du Travail"],
    [fmt(new Date(y,4,8)), "Victoire 1945"],
    [fmt(add(e,39)), "Ascension"],
    [fmt(add(e,50)), "Lundi de Pentec√¥te"],
    [fmt(new Date(y,6,14)), "F√™te Nationale"],
    [fmt(new Date(y,7,15)), "Assomption"],
    [fmt(new Date(y,10,1)), "Toussaint"],
    [fmt(new Date(y,10,11)), "Armistice"],
    [fmt(new Date(y,11,25)), "No√´l"],
  ];
  return list;
}

function buildHolidaySet(start, end) {
  const set = {};
  const years = new Set();
  let d = new Date(start);
  while (d <= end) { years.add(d.getFullYear()); d.setDate(d.getDate()+1); }
  years.forEach(y => {
    getHolidays(y).forEach(([dt, name]) => { set[dt] = name; });
  });
  return set;
}

// ===================== √âTAT =====================
const DAYS = ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
// day index 0=Mon...6=Sun (ISO)
let week = [
  {on:true, start:'06:00', end:'14:00'},
  {on:true, start:'06:00', end:'14:00'},
  {on:true, start:'06:00', end:'14:00'},
  {on:true, start:'06:00', end:'14:00'},
  {on:true, start:'06:00', end:'14:00'},
  {on:false, start:'06:00', end:'14:00'},
  {on:false, start:'06:00', end:'14:00'},
];

// ===================== INIT =====================
function init() {
  const today = new Date();
  const y = today.getFullYear(), m = today.getMonth();
  const start = new Date(y, m, 1);
  const end = new Date(y, m+1, 0);
  document.getElementById('dateStart').value = fmt(start);
  document.getElementById('dateEnd').value = fmt(end);
  buildWeekTable();
  compute();
}

function fmt(d) { return d.toISOString().slice(0,10); }
function fmtFR(d) { return d.toLocaleDateString('fr-FR'); }
function parseDate(s) { const [y,m,d] = s.split('-'); return new Date(+y,+m-1,+d); }
function minToHM(min) {
  const h = Math.floor(Math.abs(min)/60), m = Math.abs(min)%60;
  return `${h}h${m.toString().padStart(2,'0')}`;
}
function timeToMin(t) { const [h,m] = t.split(':'); return +h*60+ +m; }

// ===================== TABLE =====================
function buildWeekTable() {
  const t = document.getElementById('week-table');
  t.innerHTML = '';
  DAYS.forEach((name, i) => {
    const row = document.createElement('div');
    row.className = 'day-row';
    const checked = week[i].on ? 'checked' : '';
    row.innerHTML = `
      <span class="day-label">${name}</span>
      <input type="checkbox" ${checked} onchange="week[${i}].on=this.checked; compute()">
      <div>
        <label>D√©but</label>
        <input type="time" value="${week[i].start}" onchange="week[${i}].start=this.value; compute()">
      </div>
      <div>
        <label>Fin</label>
        <input type="time" value="${week[i].end}" onchange="week[${i}].end=this.value; compute()">
      </div>
      <div style="font-size:.75rem; color:var(--muted); min-width:50px;" id="day-info-${i}"></div>
    `;
    t.appendChild(row);
  });
}

function resetWeek() {
  week = DAYS.map((_, i) => ({ on: i < 5, start: '06:00', end: '14:00' }));
  buildWeekTable();
  compute();
}

// ===================== CALCUL PRINCIPAL =====================
function getShiftMinutes(startMin, endMin) {
  // returns total minutes, handling overnight
  if (endMin > startMin) return endMin - startMin;
  if (endMin < startMin) return (24*60 - startMin) + endMin; // overnight
  return 0;
}

function getSegments(dateStr, startMin, endMin) {
  // returns array of {date, from, to} segments (splitting at midnight if overnight)
  if (endMin === startMin) return [];
  if (endMin > startMin) {
    return [{ date: dateStr, from: startMin, to: endMin }];
  }
  // overnight: split at midnight
  const d = parseDate(dateStr);
  const next = new Date(d); next.setDate(next.getDate()+1);
  return [
    { date: dateStr, from: startMin, to: 24*60 },
    { date: fmt(next), from: 0, to: endMin },
  ];
}

function categorizeMinutesWithOverride(seg, holidaySet, forcedDow) {
  // forcedDow: si >= 0, utilise cette valeur pour dow (permet de neutraliser dimanche/f√©ri√©)
  const r = {total:0, day:0, night:0, sunDay:0, sunNight:0, holDay:0, holNight:0};
  const dow = forcedDow >= 0 ? forcedDow : parseDate(seg.date).getDay();
  const isSun = dow === 0;
  const isHol = !!holidaySet[seg.date];
  const from = seg.from, to = Math.min(seg.to, 24*60);
  if (from >= to) return r;
  r.total = to - from;
  function addMin(start, end, type) {
    const mins = Math.max(0, Math.min(end, to) - Math.max(start, from));
    if (mins <= 0) return;
    if (isHol) { if (type==='day') r.holDay+=mins; else r.holNight+=mins; }
    else if (isSun) { if (type==='day') r.sunDay+=mins; else r.sunNight+=mins; }
    else { if (type==='day') r.day+=mins; else r.night+=mins; }
  }
  addMin(0, 360, 'night'); addMin(360, 1260, 'day'); addMin(1260, 1440, 'night');
  return r;
}

function categorizeMinutes(seg, holidaySet) {
  // seg: {date, from, to}
  // returns {total, day, night, sunDay, sunNight, holDay, holNight}
  const r = {total:0, day:0, night:0, sunDay:0, sunNight:0, holDay:0, holNight:0};
  const d = parseDate(seg.date);
  const dow = d.getDay(); // 0=Sun
  const isSun = dow === 0;
  const isHol = !!holidaySet[seg.date];
  // boundaries: 6*60=360, 21*60=1260
  const from = seg.from, to = Math.min(seg.to, 24*60);
  if (from >= to) return r;
  r.total = to - from;

  function addMin(start, end, type) {
    const mins = Math.max(0, Math.min(end, to) - Math.max(start, from));
    if (mins <= 0) return;
    if (isHol) {
      if (type === 'day') r.holDay += mins; else r.holNight += mins;
    } else if (isSun) {
      if (type === 'day') r.sunDay += mins; else r.sunNight += mins;
    } else {
      if (type === 'day') r.day += mins; else r.night += mins;
    }
  }
  // night 0‚Äì360
  addMin(0, 360, 'night');
  // day 360‚Äì1260
  addMin(360, 1260, 'day');
  // night 1260‚Äì1440
  addMin(1260, 1440, 'night');
  return r;
}

function isoWeek(d) {
  const tmp = new Date(d);
  tmp.setHours(0,0,0,0);
  tmp.setDate(tmp.getDate() + 3 - (tmp.getDay()+6)%7);
  const week1 = new Date(tmp.getFullYear(), 0, 4);
  return 1 + Math.round(((tmp-week1)/86400000 - 3 + (week1.getDay()+6)%7)/7);
}

function compute() {
  const s = document.getElementById('dateStart').value;
  const e = document.getElementById('dateEnd').value;
  if (!s || !e) return;
  const start = parseDate(s), end = parseDate(e);
  if (start > end) { showAlerts([{type:'err', msg:'La date de fin doit √™tre apr√®s la date de d√©but.'}]); return; }

  // Period info
  const days = Math.round((end - start)/86400000) + 1;
  const months = (end.getFullYear() - start.getFullYear())*12 + end.getMonth() - start.getMonth() + 1;
  const isoWeeks = new Set();
  let d = new Date(start);
  while (d <= end) { isoWeeks.add(d.getFullYear()+'_'+isoWeek(d)); d.setDate(d.getDate()+1); }
  document.getElementById('periodInfo').innerHTML = `${days} jour(s) ¬∑ ~${months} mois ¬∑ ${isoWeeks.size} semaine(s) ISO`;

  // Build holiday set
  const holidays = buildHolidaySet(start, end);
  // Preview
  const hList = Object.entries(holidays).filter(([dt])=>dt>=s&&dt<=e).sort((a,b)=>a[0]<b[0]?-1:1);
  document.getElementById('holidays-preview').innerHTML = hList.length
    ? hList.map(([dt,nm])=>`<span>üìå ${fmtFR(parseDate(dt))} ‚Äì ${nm}</span><br>`).join('')
    : 'Aucun jour f√©ri√© sur la p√©riode.';

  // Validate shifts
  const errs = [];
  week.forEach((w, i) => {
    if (!w.on) return;
    const sM = timeToMin(w.start), eM = timeToMin(w.end);
    const dur = getShiftMinutes(sM, eM);
    if (dur === 0) { errs.push({type:'err', msg:`${DAYS[i]}: dur√©e nulle (m√™me heure d√©but/fin).`}); return; }
    if (dur > 12*60) errs.push({type:'err', msg:`${DAYS[i]}: shift de ${minToHM(dur)} d√©passe 12h.`});
    document.getElementById(`day-info-${i}`).textContent = minToHM(dur);
  });

  // Check 12h rest
  const activeDays = week.map((w,i)=>({...w, i})).filter(w=>w.on);
  for (let k = 0; k < activeDays.length; k++) {
    const curr = activeDays[k], next = activeDays[(k+1)%activeDays.length];
    if (curr === next) continue;
    const currEnd = timeToMin(curr.end);
    const nextStart = timeToMin(next.start);
    const daysGap = ((next.i - curr.i + 7) % 7);
    // end of curr in absolute minutes from Mon 00:00
    const currEndAbs = curr.i * 24*60 + currEnd;
    const nextStartAbs = next.i * 24*60 + nextStart + (daysGap === 0 ? 7*24*60 : 0);
    // handle overnight: if currEnd < currStart, add 24h to currEndAbs
    const cS = timeToMin(curr.start), cE = timeToMin(curr.end);
    const realEnd = cE > cS ? currEndAbs : currEndAbs + 24*60 - cS + cE - (currEndAbs - curr.i*24*60 - cS); 
    // simpler approach
    const endMin = curr.i*24*60 + (cE <= cS ? cE + 24*60 : cE);
    const startMin = next.i*24*60 + timeToMin(next.start) + (daysGap === 0 ? 7*24*60 : 0);
    const rest = startMin - endMin;
    if (rest < 12*60) errs.push({type:'warn', msg:`Repos insuffisant entre ${DAYS[curr.i]} et ${DAYS[next.i]}: ${minToHM(rest)} (min 12h).`});
  }

  // Generate all daily events
  const totals = {total:0, day:0, night:0, sunDay:0, sunNight:0, holDay:0, holNight:0};
  const weekMap = {}; // isoKey -> minutes
  const periodRows = [];
  const errors_week = {};

  d = new Date(start);
  while (d <= end) {
    const ds = fmt(d);
    const dow = d.getDay(); // 0=Sun, 1=Mon...6=Sat
    const isoIdx = (dow + 6) % 7; // 0=Mon...6=Sun
    const w = week[isoIdx];
    // Si ce jour n'est pas coch√© dans le poste, aucune heure ne doit √™tre compt√©e,
    // m√™me si le jour tombe un dimanche ou un f√©ri√©.
    const wk = d.getFullYear()+'_W'+String(isoWeek(d)).padStart(2,'0');
    if (!weekMap[wk]) weekMap[wk] = 0;

    if (w.on) {
      const segs = getSegments(ds, timeToMin(w.start), timeToMin(w.end));
      let rowTotal = 0;
      segs.forEach(seg => {
        const segDate = parseDate(seg.date);
        const segDow = segDate.getDay();
        const segIsoIdx = (segDow + 6) % 7;
        // R√®gle m√©tier (OPTION A) : jour non coch√© => 0 heure compt√©e,
        // y compris pour la portion apr√®s minuit d'un shift d√©bordant.
        if (!week[segIsoIdx].on) return;
        const c = categorizeMinutesWithOverride(seg, holidays, segDow);
        Object.keys(totals).forEach(k => totals[k] += c[k]);
        rowTotal += c.total;
      });
      weekMap[wk] += rowTotal;
      if (weekMap[wk] > 48*60) errors_week[wk] = weekMap[wk];
      const isHol = !!holidays[ds];
      const isSun = dow === 0;
      periodRows.push({ date: ds, w, isHol, isSun, holName: holidays[ds], segs, rowTotal });
    } else {
      // Jour non travaill√© : on note quand m√™me dimanche/f√©ri√© pour l'affichage calendrier,
      // mais aucune heure n'est comptabilis√©e.
      periodRows.push({ date: ds, w, isHol: !!holidays[ds], isSun: dow===0, holName: holidays[ds], segs:[], rowTotal:0 });
    }
    d.setDate(d.getDate()+1);
  }

  // Week errors
  Object.entries(errors_week).forEach(([wk, min]) => {
    errs.push({type:'err', msg:`Semaine ${wk.replace('_',' ')}: ${minToHM(min)} travaill√©s (max 48h).`});
  });

  showAlerts(errs);
  renderKPI(totals, days, months);
  renderWeekViz();
  renderPeriod(periodRows, holidays);
}

function showAlerts(errs) {
  const div = document.getElementById('alerts');
  if (!errs.length) { div.innerHTML = '<div class="alert alert-ok">‚úÖ Aucune anomalie d√©tect√©e.</div>'; return; }
  div.innerHTML = errs.map(e => `<div class="alert alert-${e.type==='err'?'err':'warn'}">
    ${e.type==='err'?'‚ùå':'‚ö†Ô∏è'} ${e.msg}
  </div>`).join('');
}

function renderKPI(t, days, months) {
  const holTotal = t.holDay + t.holNight;
  const sunTotal = t.sunDay + t.sunNight;
  const kpis = [
    {lbl:'Total heures', val: minToHM(t.total), color:'#2563eb'},
    {lbl:'Heures jour', val: minToHM(t.day + t.sunDay + t.holDay), color:'#d97706'},
    {lbl:'Heures nuit', val: minToHM(t.night + t.sunNight + t.holNight), color:'#4338ca'},
    {lbl:'Dimanche jour', val: minToHM(t.sunDay), color:'#be185d'},
    {lbl:'Dimanche nuit', val: minToHM(t.sunNight), color:'#9d174d'},
    {lbl:'F√©ri√© jour', val: minToHM(t.holDay), color:'#dc2626'},
    {lbl:'F√©ri√© nuit', val: minToHM(t.holNight), color:'#991b1b'},
  ];
  document.getElementById('kpi-grid').innerHTML = kpis.map(k =>
    `<div class="kpi"><div class="val" style="color:${k.color}">${k.val}</div><div class="lbl">${k.lbl}</div></div>`
  ).join('');
  // Benchmarks
  const avgMonthly = t.total / Math.max(1, months);
  const ref = 151.67 * 60;
  const pct = Math.round(avgMonthly / ref * 100);
  document.getElementById('benchmarks').innerHTML = `
    <b>Rep√®res :</b> R√©f√©rence mensuelle = 151h40 (1645h/an)<br>
    Moyenne sur la p√©riode : <b>${minToHM(avgMonthly)}/mois</b> (${pct}% de la r√©f√©rence)
    <div class="stat-bar"><div class="stat-fill" style="width:${Math.min(pct,100)}%; background:${pct>100?'#dc2626':'#2563eb'}"></div></div>
  `;
}

function renderWeekViz() {
  const div = document.getElementById('tab-week');
  let html = '<div class="tl-labels"><span>00h</span><span>06h</span><span>12h</span><span>18h</span><span>24h</span></div>';
  html += '<div style="display:grid; grid-template-columns: 70px 1fr; gap:6px; align-items:center;">';
  DAYS.forEach((name, i) => {
    const w = week[i];
    html += `<div style="font-size:.8rem; font-weight:${w.on?600:400}; color:${w.on?'var(--text)':'var(--muted)'}">${name}</div>`;
    if (!w.on) { html += `<div class="timeline"></div>`; }
    else {
      const sM = timeToMin(w.start), eM = timeToMin(w.end);
      const total = 24*60;
      let bars = '';
      if (eM > sM) {
        bars += tBar(sM, eM, total);
      } else {
        bars += tBar(sM, 24*60, total);
        bars += tBar(0, eM, total);
      }
      const dur = getShiftMinutes(sM, eM);
      html += `<div class="timeline" title="${w.start}‚Äì${w.end} (${minToHM(dur)})">${bars}</div>`;
    }
  });
  html += '</div>';
  html += `<div style="margin-top:8px; font-size:.75rem; display:flex; gap:12px;">
    <span style="display:flex;align-items:center;gap:4px;"><span style="width:12px;height:12px;background:#fbbf24;border-radius:2px;display:inline-block"></span>Jour (06‚Äì21h)</span>
    <span style="display:flex;align-items:center;gap:4px;"><span style="width:12px;height:12px;background:#6366f1;border-radius:2px;display:inline-block"></span>Nuit (21‚Äì06h)</span>
  </div>`;
  div.innerHTML = html;
}

function tBar(from, to, total) {
  const D6=360, D21=1260;
  let html = '';
  // split into day/night segments
  const segs = splitDayNight(from, to);
  segs.forEach(s => {
    const left = s.from/total*100, width = (s.to-s.from)/total*100;
    const cls = s.night ? 'tl-bar tl-night' : 'tl-bar tl-day';
    html += `<div class="${cls}" style="left:${left}%;width:${width}%"></div>`;
  });
  return html;
}

function splitDayNight(from, to) {
  // boundaries at 0,360,1260,1440
  const bounds = [0, 360, 1260, 1440];
  const segs = [];
  for (let i = 0; i < bounds.length-1; i++) {
    const s = Math.max(from, bounds[i]), e = Math.min(to, bounds[i+1]);
    if (e > s) segs.push({from:s, to:e, night: bounds[i]<360||bounds[i]>=1260});
  }
  return segs;
}

function renderPeriod(rows, holidays) {
  const div = document.getElementById('tab-period');
  let html = '<div class="period-list">';
  html += `<div class="period-row" style="font-weight:600; font-size:.8rem;">
    <span>Date</span><span>Shift</span><span>Timeline</span><span>Dur√©e</span>
  </div>`;
  rows.forEach(r => {
    const d = parseDate(r.date);
    const badges = (r.isSun ? '<span class="badge badge-sun">Dim</span>' : '') + (r.isHol ? `<span class="badge badge-hol" title="${r.holName}">F√©r</span>` : '');
    const bg = r.isHol ? '#fef2f2' : r.isSun ? '#fdf4ff' : '';
    if (!r.w.on || r.segs.length === 0) {
      html += `<div class="period-row" style="background:${bg}; color:var(--muted)">
        <span>${fmtFR(d)}${badges}</span><span>‚Äì</span><span></span><span></span>
      </div>`;
    } else {
      const sM = timeToMin(r.w.start), eM = timeToMin(r.w.end);
      const total = 24*60;
      let bars = eM > sM ? tBar(sM, eM, total) : tBar(sM, 24*60, total) + tBar(0, eM, total);
      html += `<div class="period-row" style="background:${bg}">
        <span>${fmtFR(d)}${badges}</span>
        <span style="font-size:.75rem">${r.w.start}‚Äì${r.w.end}</span>
        <div class="timeline" style="height:18px">${bars}</div>
        <span>${minToHM(r.rowTotal)}</span>
      </div>`;
    }
  });
  html += '</div>';
  div.innerHTML = html;
}

function showTab(name, el) {
  document.querySelectorAll('[id^=tab-]').forEach(d => d.style.display='none');
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+name).style.display='block';
  el.classList.add('active');
}

function exportCSV() {
  const s = document.getElementById('dateStart').value;
  const e = document.getElementById('dateEnd').value;
  if (!s || !e) return;
  const start = parseDate(s), end = parseDate(e);
  const holidays = buildHolidaySet(start, end);
  let csv = 'Date;Debut;Fin;Total_min;Jour_min;Nuit_min;Dimanche_min;Ferie_min;SemaineISO\n';
  let d = new Date(start);
  while (d <= end) {
    const ds = fmt(d);
    const dow = d.getDay(), isoIdx = (dow+6)%7;
    const w = week[isoIdx];
    const wk = isoWeek(d);
    if (w.on) {
      const segs = getSegments(ds, timeToMin(w.start), timeToMin(w.end));
      let tot=0,day=0,night=0,sun=0,hol=0;
      segs.forEach(seg => {
        const segDate = parseDate(seg.date);
        const segDow = segDate.getDay();
        const segIsoIdx = (segDow + 6) % 7;
        // M√™me r√®gle qu'au calcul KPI : jour non coch√© => 0 heure export√©e.
        if (!week[segIsoIdx].on) return;
        const c = categorizeMinutes(seg, holidays);
        tot+=c.total; day+=c.day+c.sunDay+c.holDay; night+=c.night+c.sunNight+c.holNight;
        sun+=c.sunDay+c.sunNight; hol+=c.holDay+c.holNight;
      });
      csv += `${fmtFR(d)};${w.start};${w.end};${tot};${day};${night};${sun};${hol};${wk}\n`;
    }
    d.setDate(d.getDate()+1);
  }
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='planning_FR.csv'; a.click();
}

function copyResume() {
  const kpis = document.getElementById('kpi-grid').innerText;
  const bench = document.getElementById('benchmarks').innerText;
  navigator.clipboard.writeText('=== Planning Builder FR ===\n' + kpis + '\n' + bench)
    .then(() => alert('R√©sum√© copi√© !'));
}

// Sanity checks console (manuel): window.runSanityChecks()
function runSanityChecks() {
  const prevWeek = JSON.parse(JSON.stringify(week));
  const prevStart = document.getElementById('dateStart').value;
  const prevEnd = document.getElementById('dateEnd').value;
  const parseHM = txt => {
    const m = txt.match(/(\d+)h(\d+)/);
    return m ? (+m[1])*60 + (+m[2]) : 0;
  };
  const kpiVal = label => {
    const cards = Array.from(document.querySelectorAll('#kpi-grid .kpi'));
    const card = cards.find(c => c.querySelector('.lbl')?.innerText.trim() === label);
    return card ? parseHM(card.querySelector('.val')?.innerText || '0h00') : 0;
  };
  const run = (name, setup, assert) => {
    setup();
    compute();
    const ok = assert();
    console.log(`${ok ? '‚úÖ' : '‚ùå'} ${name}`);
  };

  // Sc√©nario 1: dimanche OFF + samedi 21:00‚Üí05:00 => KPI dimanche = 0, total = 3h (samedi 21‚Üí24)
  run(
    'S1 dimanche OFF, samedi 21‚Üí05',
    () => {
      week = DAYS.map(() => ({on:false, start:'06:00', end:'14:00'}));
      week[5] = {on:true, start:'21:00', end:'05:00'}; // samedi
      week[6] = {on:false, start:'06:00', end:'14:00'}; // dimanche
    },
    () => kpiVal('Dimanche jour') === 0 && kpiVal('Dimanche nuit') === 0 && kpiVal('Total heures') === 180
  );

  // Sc√©nario 2: dimanche ON + samedi 21:00‚Üí05:00 => KPI dimanche nuit > 0
  run(
    'S2 dimanche ON, samedi 21‚Üí05',
    () => {
      week = DAYS.map(() => ({on:false, start:'06:00', end:'14:00'}));
      week[5] = {on:true, start:'21:00', end:'05:00'};
      week[6] = {on:true, start:'06:00', end:'14:00'};
    },
    () => kpiVal('Dimanche nuit') > 0
  );

  // Sc√©nario 3: dimanche OFF + horaires saisis le dimanche => aucune heure
  run(
    'S3 dimanche OFF, horaires dimanche saisis',
    () => {
      week = DAYS.map(() => ({on:false, start:'06:00', end:'14:00'}));
      week[6] = {on:false, start:'06:00', end:'14:00'};
    },
    () => kpiVal('Dimanche jour') === 0 && kpiVal('Dimanche nuit') === 0 && kpiVal('Total heures') === 0
  );

  week = prevWeek;
  document.getElementById('dateStart').value = prevStart;
  document.getElementById('dateEnd').value = prevEnd;
  buildWeekTable();
  compute();
}

window.runSanityChecks = runSanityChecks;
window.onload = init;
</script>
</body>
</html>
